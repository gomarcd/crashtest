name: Prepare Winget Submission

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.0.10)'
        required: true
      full_version:
        description: 'Full version (e.g., 2025.0.0.10)'
        required: true
      sha256:
        description: 'SHA256 hash of the installer (from release notes)'
        required: true

jobs:
  prepare-winget:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create Manifest
        shell: pwsh
        run: |
          # Create manifest directory structure
          $AppName = "${{ secrets.APP_NAME }}"
          $Publisher = "gomarcd"
          $Version = "${{ github.event.inputs.full_version }}"
          $FirstLetter = $Publisher.Substring(0,1).ToLower()
          $Hash = "${{ github.event.inputs.sha256 }}"
          
          $manifestPath = "manifests\$FirstLetter\$Publisher\$AppName\$Version"
          New-Item -Path $manifestPath -ItemType Directory -Force
          
          # Use the correct file naming pattern
          $installerFileName = "${AppName}_${Version}_amd64_installer.exe"
          
          # Create the YAML file line by line
          $lines = @()
          $lines += "PackageIdentifier: $Publisher.$AppName"
          $lines += "PackageVersion: $Version"
          $lines += "PackageName: $AppName"
          $lines += "Publisher: $Publisher"
          $lines += "License: MIT"
          $lines += "LicenseUrl: https://github.com/${{ github.repository }}/blob/main/LICENSE"
          $lines += "ShortDescription: The fast, minimal API tool"
          $lines += "Description: $AppName is a fast, minimal API client designed with privacy and security in mind."
          $lines += "PackageUrl: https://github.com/${{ github.repository }}"
          $lines += "Installers:"
          $lines += "  - Architecture: x64"
          $lines += "    InstallerType: exe"
          $lines += "    InstallerUrl: https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag }}/$installerFileName"
          $lines += "    InstallerSha256: $Hash"
          $lines += "    InstallerSwitches:"
          $lines += "      Silent: /S"
          $lines += "      SilentWithProgress: /S"
          $lines += "ManifestType: singleton"
          $lines += "ManifestVersion: 1.0.0"
          
          # Write the lines to the file
          Set-Content -Path "$manifestPath\$Publisher.$AppName.yaml" -Value $lines
          
          Write-Host "Manifest file created at: $manifestPath\$Publisher.$AppName.yaml"
          Get-Content "$manifestPath\$Publisher.$AppName.yaml"
      
      - name: Upload Manifest
        uses: actions/upload-artifact@v4
        with:
          name: winget-submission
          path: manifests
          retention-days: 7
          
      - name: Provide Submission Instructions
        run: |
          Write-Host "==== WINGET SUBMISSION INSTRUCTIONS ===="
          Write-Host "1. Download the 'winget-submission' artifact"
          Write-Host "2. Extract the contents"
          Write-Host "3. Fork the microsoft/winget-pkgs repository"
          Write-Host "4. Copy the manifest directory structure to your fork"
          Write-Host "5. Commit and create a PR to microsoft/winget-pkgs"
          Write-Host "==== END INSTRUCTIONS ===="